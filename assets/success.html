<!DOCTYPE html>
<html lang="es">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Pago Exitoso - Tu Ticket</title>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js" defer></script>
   <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.3.1/lib/qr-code-styling.min.js" defer></script>
   <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
      import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

      const firebaseConfig = {
         apiKey: "AIzaSyBDJeze6ibv446maeLso00v5hWx-7o3vpc",
         authDomain: "parquediversiones-5bef1.firebaseapp.com",
         projectId: "parquediversiones-5bef1",
         storageBucket: "parquediversiones-5bef1.appspot.com",
         messagingSenderId: "534239241861",
         appId: "1:534239241861:web:1113c526f8cfe17c996bec"
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      function generarCodigoQR() {
         return Math.random().toString(36).substring(2, 10).toUpperCase();
      }

      async function guardarTicketEnFirebase(transactionId, entrada) {
         try {
            await addDoc(collection(db, "tickets"), {
               codigoQR: transactionId,
               fecha: new Date(),
               usado: false,
               entrada: entrada
            });
            console.log("Ticket guardado en Firebase");
         } catch (e) {
            console.error("Error al guardar el ticket: ", e);
         }
      }

      document.addEventListener("DOMContentLoaded", function () {
    console.log("üîπ Todos los scripts han sido cargados correctamente.");
    window.jsPDF = window.jspdf.jsPDF;

    let params = new URLSearchParams(window.location.search);
    let transactionId = params.get("transactionId");

if (!transactionId) {
    transactionId = generarCodigoQR();
    console.log("‚ö†Ô∏è No se encontr√≥ transactionId en la URL. Generando uno nuevo:", transactionId);
}
    let productId = params.get("product");

    console.log("Producto detectado:", productId);

    if (!productId) {
        console.warn("‚ö†Ô∏è No se encontr√≥ un productId en la URL.");
    }

    let entrada = "Tu Ticket";

    // ‚úÖ Si no hay transactionId en la URL ni en localStorage, generar uno nuevo
    if (!transactionId) {
        transactionId = generarCodigoQR();
        localStorage.setItem("transactionId", transactionId); // üîπ Guardarlo para evitar duplicados
        console.log("Nuevo transactionId generado:", transactionId);
    } else {
        console.log("Usando transactionId existente:", transactionId);
    }
     // ‚úÖ Guardar siempre en Firebase
     guardarTicketEnFirebase(transactionId, entrada);
    document.getElementById("transactionId").innerText = transactionId;
    document.getElementById("entrada").innerText = entrada;
    
    let qrContainer = document.getElementById("qrcode");
    qrContainer.innerHTML = ""; 
    const qrCode = new QRCodeStyling({
        width: 250,
        height: 250,
        type: "svg",
        data: `https://tu-parque.com/validar?ticket=${transactionId}`,
        dotsOptions: { color: "#000", type: "rounded" },
        backgroundOptions: { color: "#FFF" }
    });
    qrCode.append(qrContainer);

    // ‚úÖ Guardar en Firebase solo si es un nuevo transactionId
    if (!localStorage.getItem("ticketSaved")) {
        guardarTicketEnFirebase(transactionId, entrada);
        localStorage.setItem("ticketSaved", "true"); // üîπ Marcar que ya se guard√≥
    } else {
        console.log("El ticket ya estaba guardado en Firebase, evitando duplicados.");
    }

    // ‚úÖ Asignar eventos a los botones
    console.log("Asignando eventos a los botones...");

    // Evento para descargar imagen
    document.getElementById("downloadImage").addEventListener("click", downloadImage);
    document.getElementById("downloadPDF").addEventListener("click", downloadPDF);

    // ‚úÖ Verificaci√≥n del bot√≥n 'Volver al Inicio'
    let goHomeButton = document.getElementById("goHome");
    if (goHomeButton) {
        console.log("‚úÖ Bot√≥n 'Volver al Inicio' encontrado.");
        goHomeButton.addEventListener("click", function () {
            console.log("‚úÖ Bot√≥n de volver al inicio clickeado.");
            window.location.href = window.location.origin + "/index.html"; // üîπ Redirige a la p√°gina de inicio
        });
    } else {
        console.error("‚ùå Error: Bot√≥n 'Volver al Inicio' NO encontrado.");
    }

    console.log("Eventos asignados correctamente.");
});

// üîπ Funci√≥n para descargar imagen
function downloadImage() {
    console.log("Intentando descargar imagen...");
    html2canvas(document.getElementById("ticket"), { scale: 3 }).then(canvas => {
        let link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = "ticket.png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log("Imagen descargada correctamente.");
    }).catch(error => console.error("Error al capturar la imagen: ", error));
}

// üîπ Funci√≥n para descargar PDF
function downloadPDF() {
    console.log("Intentando generar PDF...");
    const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
    html2canvas(document.getElementById("ticket"), { scale: 3 }).then(canvas => {
        let imgData = canvas.toDataURL("image/png");
        let imgWidth = 150;
        let imgHeight = (canvas.height * imgWidth) / canvas.width;
        let posX = (doc.internal.pageSize.width - imgWidth) / 2;
        let posY = 30;
        doc.addImage(imgData, "PNG", posX, posY, imgWidth, imgHeight);
        doc.save("ticket.pdf");
        console.log("PDF generado correctamente.");
    }).catch(error => console.error("Error al generar el PDF: ", error));
}
   </script>
   <style>
      body { text-align: center; font-family: Arial, sans-serif; }
      .ticket-container { width: 300px; margin: auto; padding: 20px; border: 2px solid black; background: #fff; text-align: center; }
      #qrcode { margin: 10px auto; display: flex; justify-content: center; }
      button { margin: 10px; padding: 10px; border: none; background: #007bff; color: white; cursor: pointer; border-radius: 5px; }
      button:hover { background: #0056b3; }
   </style>
</head>
<body>
   <h2>¬°Gracias por tu compra!</h2>
   <p>Tu pago ha sido exitoso. A continuaci√≥n, puedes descargar tu ticket.</p>
   <div class="ticket-container" id="ticket">
      <h3 id="entrada">Tu Ticket</h3>
      <p>Diversi√≥n Infinita</p>
      <p>ID de transacci√≥n: <span id="transactionId"></span></p>
      <div id="qrcode"></div>
   </div>
   <button id="downloadImage">Descargar Imagen</button>
   <button id="downloadPDF">Descargar PDF</button>
   <button id="goHome">Volver al Inicio</button> 

</body>
</html>
