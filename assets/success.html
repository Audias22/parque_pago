<!DOCTYPE html>
<html lang="es">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Pago Exitoso - Tu Ticket</title>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js" defer></script>
   <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.3.1/lib/qr-code-styling.min.js" defer></script>

   <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
      import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

      const firebaseConfig = {
         apiKey: "AIzaSyBDJeze6ibv446maeLso00v5hWx-7o3vpc",
         authDomain: "parquediversiones-5bef1.firebaseapp.com",
         projectId: "parquediversiones-5bef1",
         storageBucket: "parquediversiones-5bef1.appspot.com",
         messagingSenderId: "534239241861",
         appId: "1:534239241861:web:1113c526f8cfe17c996bec"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      function generarCodigoQR() {
         return Math.random().toString(36).substring(2, 10).toUpperCase();
      }

      async function guardarTicketEnFirebase(transactionId) {
         try {
            // Verificar si el ticket ya existe en Firebase para evitar duplicados
            const q = query(collection(db, "tickets"), where("codigoQR", "==", transactionId));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
               console.log("‚ö†Ô∏è Ticket ya existe en Firebase, no se guarda nuevamente.");
               return;
            }

            await addDoc(collection(db, "tickets"), {
               codigoQR: transactionId,
               fecha: new Date(),
               usado: false
            });

            console.log("‚úÖ Ticket guardado en Firebase:", transactionId);
         } catch (e) {
            console.error("‚ùå Error al guardar el ticket en Firebase:", e);
         }
      }

      document.addEventListener("DOMContentLoaded", async function () {
         console.log("üîπ Iniciando carga de ticket...");

         window.jsPDF = window.jspdf.jsPDF;

         let params = new URLSearchParams(window.location.search);
         let transactionId = params.get("transactionId");

         if (!transactionId) {
            transactionId = localStorage.getItem("transactionId");

            if (!transactionId) {
               transactionId = generarCodigoQR();
               localStorage.setItem("transactionId", transactionId);
               console.log("‚ö†Ô∏è No se encontr√≥ transactionId en URL. Se gener√≥ uno nuevo:", transactionId);
            } else {
               console.log("‚úÖ Se us√≥ transactionId desde localStorage:", transactionId);
            }
         } else {
            console.log("‚úÖ Se us√≥ transactionId desde la URL:", transactionId);
            localStorage.setItem("transactionId", transactionId);
         }

         document.getElementById("transactionId").innerText = transactionId;

         let qrContainer = document.getElementById("qrcode");
         qrContainer.innerHTML = ""; 
         const qrCode = new QRCodeStyling({
            width: 250,
            height: 250,
            type: "svg",
            data: transactionId,
            dotsOptions: { color: "#000", type: "rounded" },
            backgroundOptions: { color: "#FFF" }
         });
         qrCode.append(qrContainer);

         await guardarTicketEnFirebase(transactionId);

         document.getElementById("downloadImage").addEventListener("click", downloadImage);
         document.getElementById("downloadPDF").addEventListener("click", downloadPDF);

         let goHomeButton = document.getElementById("goHome");
         if (goHomeButton) {
            goHomeButton.addEventListener("click", function () {
               localStorage.removeItem("transactionId");
               window.location.href = window.location.origin + "/index.html";
            });
         }
      });

      function downloadImage() {
         html2canvas(document.getElementById("ticket"), { scale: 3 }).then(canvas => {
            let link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = "ticket.png";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
         });
      }

      function downloadPDF() {
         const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
         html2canvas(document.getElementById("ticket"), { scale: 3 }).then(canvas => {
            let imgData = canvas.toDataURL("image/png");
            doc.addImage(imgData, "PNG", 30, 30, 150, (canvas.height * 150) / canvas.width);
            doc.save("ticket.pdf");
         });
      }
   </script>

   <style>
      body { text-align: center; font-family: Arial, sans-serif; }
      .ticket-container { width: 300px; margin: auto; padding: 20px; border: 2px solid black; background: #fff; text-align: center; }
      #qrcode { margin: 10px auto; display: flex; justify-content: center; }
      button { margin: 10px; padding: 10px; border: none; background: #007bff; color: white; cursor: pointer; border-radius: 5px; }
      button:hover { background: #0056b3; }
   </style>
</head>
<body>
   <h2>¬°Gracias por tu compra!</h2>
   <p>Tu pago ha sido exitoso. A continuaci√≥n, puedes descargar tu ticket.</p>
   <div class="ticket-container" id="ticket">
      <h3>Tu Ticket</h3>
      <p>Diversi√≥n Infinita</p>
      <p>ID de transacci√≥n: <span id="transactionId"></span></p>
      <div id="qrcode"></div>
   </div>
   <button id="downloadImage">Descargar Imagen</button>
   <button id="downloadPDF">Descargar PDF</button>
   <button id="goHome">Volver al Inicio</button> 
</body>
</html>
